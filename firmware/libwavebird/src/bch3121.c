#include <string.h>

#include "wavebird/bch3121.h"

// Generator polynomial, g(x) = x^10 + x^9 + x^8 + x^6 + x^5 + x^3 + 1
#define BCH3121_POLYNOMIAL  0b11101101001

/**
 * LUT for error positions based on syndrome, encoded as follows:
 * - Bits 0-1:  Number of errors (0b01 = 1, 0b10 = 2, 0b00 = uncorrectable)
 * - Bits 2-6:  Position of first error
 * - Bits 7-11: Position of second error (if present)
 *
 * Generated with bch3121_generate_syndrome_table()
 */
static const uint16_t bch3121_error_positions[] = {
    0x000, 0x055, 0x059, 0xB56, 0x05D, 0xBD6, 0xBDA, 0x000, 0x061, 0xC56, 0xC5A, 0x000, 0xC5E, 0x8A6, 0x000, 0x82E,
    0x065, 0xCD6, 0xCDA, 0x626, 0xCDE, 0x000, 0x000, 0x000, 0xCE2, 0x706, 0x92A, 0x000, 0x000, 0x000, 0x8B2, 0x102,
    0x069, 0xD56, 0xD5A, 0x000, 0xD5E, 0x000, 0x6AA, 0x70E, 0xD62, 0x000, 0x000, 0x000, 0x000, 0x782, 0x000, 0x000,
    0xD66, 0x000, 0x78A, 0x000, 0x9AE, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x9C2, 0x936, 0x000, 0x186, 0x000,
    0x06D, 0xDD6, 0xDDA, 0x83A, 0xDDE, 0x000, 0x000, 0x000, 0xDE2, 0x000, 0x000, 0x000, 0x72E, 0x000, 0x792, 0x000,
    0xDE6, 0xE36, 0x000, 0xF22, 0x000, 0x586, 0x000, 0x000, 0x000, 0x000, 0x806, 0x000, 0x000, 0x000, 0x000, 0x98E,
    0xDEA, 0x986, 0x000, 0x202, 0x80E, 0x000, 0x000, 0x39A, 0xA32, 0x000, 0x000, 0x58E, 0x000, 0xE4A, 0x000, 0x000,
    0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0xA46, 0xE2A, 0x9BA, 0x000, 0x000, 0xA26, 0x20A, 0xE96, 0x000, 0x000,
    0x071, 0xE56, 0xE5A, 0x000, 0xE5E, 0xE8E, 0x8BE, 0x000, 0xE62, 0x000, 0x000, 0x7A6, 0x000, 0x000, 0x000, 0x000,
    0xE66, 0xDB6, 0x000, 0x596, 0x000, 0x000, 0x000, 0x000, 0x7B2, 0x000, 0x000, 0x000, 0x816, 0xF1E, 0x000, 0x000,
    0xE6A, 0x000, 0xEBA, 0x000, 0x000, 0x000, 0x482, 0x996, 0x000, 0x41A, 0x60A, 0x882, 0x000, 0xDCA, 0x000, 0x000,
    0x000, 0x000, 0x000, 0x000, 0x88A, 0x602, 0x000, 0xDAA, 0x000, 0x48A, 0x000, 0xE86, 0x000, 0x000, 0xA12, 0x000,
    0xE6E, 0xCB6, 0xA0A, 0x000, 0x000, 0x492, 0x286, 0x000, 0x892, 0x000, 0x000, 0x000, 0x000, 0xD4A, 0x41E, 0x000,
    0xAB6, 0x035, 0x000, 0xB36, 0x000, 0xBB6, 0x612, 0xD2A, 0x000, 0xC36, 0xECE, 0x000, 0x000, 0xA02, 0x000, 0x716,
    0x000, 0xEC2, 0x000, 0x000, 0x000, 0xC4A, 0x000, 0xCAA, 0x000, 0xBCA, 0x000, 0x000, 0xACA, 0x049, 0xEAE, 0xB4A,
    0xA3E, 0xD36, 0x000, 0xBAA, 0x000, 0xB2A, 0xAAA, 0x029, 0x28E, 0x000, 0xF1A, 0x000, 0x000, 0xCCA, 0x000, 0xC2A,
    0x075, 0xED6, 0xEDA, 0x92E, 0xEDE, 0xE0E, 0x000, 0x000, 0xEE2, 0x000, 0xF12, 0x9B6, 0x942, 0x000, 0x000, 0x000,
    0xEE6, 0x000, 0x000, 0x000, 0x000, 0x000, 0x82A, 0x7A2, 0x000, 0x5AA, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000,
    0xEEA, 0x000, 0xE3A, 0x000, 0x000, 0x40A, 0x61A, 0x000, 0x000, 0xA1E, 0x000, 0x000, 0x000, 0x9AA, 0x000, 0x000,
    0x836, 0x000, 0x000, 0x000, 0x000, 0x49A, 0x000, 0x9CA, 0x89A, 0x000, 0x402, 0xE06, 0x000, 0xD96, 0x000, 0x6AE,
    0xEEE, 0x61E, 0x000, 0x000, 0xF3E, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x506, 0x000, 0xA1A, 0x93A,
    0x000, 0x000, 0x49E, 0x000, 0x68E, 0x72A, 0x906, 0x000, 0x000, 0x412, 0xE4E, 0x000, 0x000, 0xD16, 0x000, 0x89E,
    0x000, 0xE42, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x90E, 0xF02, 0x686, 0x000, 0x000, 0xC96, 0xE2E, 0x000,
    0x000, 0x000, 0x50E, 0x736, 0x000, 0xC16, 0xF0A, 0x000, 0x000, 0xB96, 0x000, 0x000, 0xA96, 0x015, 0x000, 0xB16,
    0xEF2, 0xB8E, 0xD3A, 0x000, 0xA8E, 0x00D, 0x000, 0xB0E, 0x000, 0x000, 0x516, 0x000, 0x30A, 0xC0E, 0x000, 0x622,
    0x916, 0x8A2, 0x000, 0x302, 0x000, 0xC8E, 0x000, 0x392, 0x000, 0x000, 0xDCE, 0xD06, 0x4A2, 0x000, 0x000, 0x000,
    0xB3A, 0xDC2, 0x039, 0xABA, 0x000, 0xD0E, 0xBBA, 0x000, 0x000, 0x000, 0xC3A, 0xC86, 0x696, 0x000, 0xDAE, 0x000,
    0x000, 0x000, 0xCBA, 0xC06, 0xF52, 0x000, 0x000, 0x000, 0x000, 0xB06, 0xA86, 0x005, 0x000, 0x000, 0x79A, 0xB86,
    0x000, 0xD42, 0xF46, 0x000, 0x000, 0xD8E, 0x000, 0x000, 0x000, 0x000, 0xCCE, 0x000, 0x000, 0x000, 0xD2E, 0xF26,
    0x000, 0xEB6, 0xC4E, 0x000, 0x000, 0x000, 0x000, 0x000, 0xB4E, 0x79E, 0x04D, 0xACE, 0xF32, 0x000, 0xBCE, 0x000,
    0xAC2, 0x041, 0xDBA, 0xB42, 0x000, 0xBC2, 0xC2E, 0xA22, 0x000, 0xC42, 0xBAE, 0x38A, 0xB2E, 0xECA, 0x02D, 0xAAE,
    0x312, 0xCC2, 0x000, 0x000, 0x382, 0x000, 0x000, 0xEAA, 0x000, 0x000, 0xD4E, 0xD86, 0x000, 0xE16, 0xCAE, 0x000,
    0x079, 0xF56, 0xF5A, 0x000, 0xF5E, 0x000, 0x9B2, 0x000, 0xF62, 0x000, 0xE92, 0x28A, 0x000, 0x51A, 0x000, 0xA06,
    0xF66, 0x000, 0x000, 0xDA2, 0x282, 0x9A6, 0xA3A, 0x91A, 0x9C6, 0x000, 0x000, 0x000, 0x000, 0xE1E, 0x000, 0x000,
    0xF6A, 0x5A6, 0x000, 0x8C2, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x69A, 0x8AE, 0x000, 0x826, 0x000,
    0x000, 0xA0E, 0x62E, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x796, 0x000, 0x000, 0x000, 0x832, 0x000, 0x000,
    0xF6E, 0x000, 0x000, 0xCA2, 0xEBE, 0x000, 0x000, 0x88E, 0x000, 0x000, 0x48E, 0x000, 0x69E, 0x000, 0x000, 0x000,
    0x000, 0xB22, 0xAA2, 0x021, 0x000, 0xA42, 0x000, 0xBA2, 0x000, 0x60E, 0xA2E, 0xC22, 0x000, 0x000, 0x000, 0x000,
    0x8BA, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x606, 0x000, 0xE82, 0x51E, 0x000, 0x000, 0x726, 0xA4E, 0x000,
    0x91E, 0x000, 0x000, 0xD22, 0x486, 0x000, 0xE8A, 0x292, 0x000, 0x886, 0xE1A, 0x000, 0x000, 0x000, 0x732, 0x000,
    0xF72, 0x000, 0x6A2, 0x000, 0x000, 0x000, 0x000, 0x582, 0x802, 0x000, 0x000, 0x000, 0x000, 0xC9E, 0x000, 0x20E,
    0x000, 0x000, 0x000, 0x000, 0x000, 0xC1E, 0x000, 0x80A, 0x58A, 0xB9E, 0x000, 0x000, 0xA9E, 0x01D, 0x9BE, 0xB1E,
    0x000, 0x616, 0x000, 0x000, 0x522, 0x83E, 0x000, 0x000, 0x712, 0x000, 0x7AE, 0x000, 0x98A, 0x000, 0x000, 0x000,
    0x000, 0x206, 0x496, 0x982, 0xED2, 0x000, 0x000, 0x000, 0x000, 0x000, 0xD9A, 0x000, 0x000, 0xD1E, 0x922, 0x896,
    0x000, 0x78E, 0xEC6, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0xA16, 0x000, 0x702, 0x000, 0x106, 0x000, 0xEA6,
    0x992, 0xF36, 0x082, 0xE22, 0x70A, 0x000, 0x000, 0x000, 0x000, 0x000, 0xD1A, 0x000, 0xEB2, 0xD9E, 0x000, 0x000,
    0x000, 0x000, 0x000, 0x000, 0x592, 0x000, 0x7BA, 0x000, 0x000, 0x000, 0xC9A, 0x812, 0x182, 0xF4A, 0x000, 0x000,
    0x000, 0x000, 0xC1A, 0x18A, 0x000, 0x000, 0x000, 0xF2A, 0xB1A, 0x000, 0x019, 0xA9A, 0x000, 0x000, 0xB9A, 0x786,
    0xF76, 0x000, 0xC12, 0x000, 0xDBE, 0x000, 0x000, 0x000, 0xB12, 0x000, 0x011, 0xA92, 0x000, 0x6B2, 0xB92, 0x000,
    0x000, 0x000, 0x000, 0x8B6, 0x59A, 0x000, 0x000, 0x000, 0x38E, 0x000, 0xC92, 0x81A, 0x000, 0x000, 0x6A6, 0x000,
    0x99A, 0x000, 0x926, 0x000, 0x000, 0x000, 0x386, 0x000, 0x000, 0xD82, 0xD12, 0x62A, 0x000, 0x000, 0x416, 0x946,
    0x000, 0x932, 0x000, 0x000, 0xE52, 0x8AA, 0xD8A, 0x000, 0x526, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000, 0x71E,
    0xBBE, 0x306, 0xE46, 0xA2A, 0x03D, 0xABE, 0xB3E, 0x99E, 0x000, 0xD02, 0xD92, 0x000, 0xC3E, 0x000, 0x000, 0xE26,
    0x000, 0x000, 0x000, 0xEA2, 0xCBE, 0x000, 0xD0A, 0x000, 0x71A, 0xA4A, 0x000, 0x000, 0xE32, 0x000, 0x000, 0x000,
    0x000, 0xC02, 0x000, 0x000, 0xD3E, 0xA36, 0xC8A, 0x000, 0xA82, 0x001, 0x000, 0xB02, 0x000, 0xB82, 0x000, 0x000,
    0x000, 0x000, 0xB8A, 0x59E, 0xB0A, 0x000, 0x009, 0xA8A, 0x000, 0xC82, 0x000, 0x000, 0x81E, 0xF16, 0xC0A, 0x30E,
    0x000, 0x50A, 0xDC6, 0x000, 0x902, 0xF0E, 0x000, 0x316, 0x000, 0x9A2, 0xE12, 0x000, 0x000, 0x000, 0x000, 0xDA6,
    0x000, 0x000, 0x000, 0x000, 0xD52, 0x7B6, 0x000, 0x000, 0x000, 0x000, 0x000, 0x90A, 0xDB2, 0xE9E, 0x502, 0x000,
    0x000, 0x000, 0xF3A, 0x000, 0xCD2, 0x000, 0x000, 0x68A, 0x000, 0x93E, 0x000, 0x000, 0x000, 0x000, 0x000, 0x000,
    0xBD2, 0x000, 0x822, 0x7AA, 0x051, 0xAD2, 0xB52, 0x000, 0x682, 0x000, 0x000, 0xF06, 0xC52, 0x5A2, 0x000, 0x000,
    0xB46, 0x000, 0x045, 0xAC6, 0xE3E, 0x000, 0xBC6, 0xC26, 0x000, 0x000, 0xC46, 0xBA6, 0xCB2, 0xB26, 0xAA6, 0x025,
    0x000, 0x000, 0xCC6, 0x000, 0xC32, 0x000, 0x40E, 0x000, 0xBB2, 0x000, 0xF4E, 0x692, 0x031, 0xAB2, 0xB32, 0xCA6,
    0x396, 0xF42, 0xD46, 0x000, 0x000, 0x000, 0x000, 0x912, 0x406, 0xE02, 0x000, 0x000, 0x000, 0x000, 0xF2E, 0xD26,
    0x000, 0x722, 0x000, 0x000, 0xDD2, 0x000, 0xE0A, 0x000, 0x000, 0x000, 0xE9A, 0x000, 0xD32, 0x512, 0x000, 0x000,
};

uint32_t bch3121_encode(uint32_t message)
{
  uint32_t codeword = 0;
  for (int i = 0; i < BCH3121_MESSAGE_LEN; i++) {
    codeword <<= 1;

    if (message & 1)
      codeword ^= BCH3121_POLYNOMIAL;

    message >>= 1;
  }

  return codeword;
}

uint32_t bch3121_decode(uint32_t *message, uint32_t codeword)
{
  uint32_t syndrome = codeword;
  *message          = 0;

  for (int i = 0; i < BCH3121_MESSAGE_LEN; i++) {
    *message <<= 1;

    if (syndrome & 1) {
      syndrome ^= BCH3121_POLYNOMIAL;
      *message |= 1;
    }

    syndrome >>= 1;
  }

  return syndrome;
}

int bch3121_decode_and_correct(uint32_t *message, uint32_t codeword)
{
  // Decode the codeword, immediately return the message if it contains no errors
  uint32_t syndrome = bch3121_decode(message, codeword);
  if (!syndrome)
    return 0;

  // There is at least one error, look up the error pattern
  uint16_t error_pattern = bch3121_error_positions[(uint16_t)syndrome];

  // Check for uncorrectable errors
  if (!error_pattern)
    return -BCH3121_ERR_UNCORRECTABLE;

  // Extract the number of errors
  uint8_t num_errors = error_pattern & 0x3;

  // Correct the first error
  codeword ^= (1 << ((error_pattern >> 2) & 0x1F));

  // Correct the second error, if present
  if (num_errors == 2)
    codeword ^= (1 << ((error_pattern >> 7) & 0x1F));

  // Decode the codeword again, now that we've corrected the errors
  bch3121_decode(message, codeword);

  return num_errors;
}

void bch3121_generate_syndrome_table(uint16_t *syndrome_table)
{
  uint32_t syndrome, tmp;
  uint32_t codeword = 0x0394a9d0; // Arbitrary codeword

  // Clear the table
  memset(syndrome_table, 0, sizeof(uint16_t) * BCH3121_ORDER);

  // Walk through all possible error patterns
  for (int i = 0; i < 31; i++) {
    // Single-bit errors
    syndrome                 = bch3121_decode(&tmp, codeword ^ (1 << i));
    syndrome_table[syndrome] = i << 2 | 1;

    // Double-bit errors
    for (int j = i + 1; j < 31; j++) {
      syndrome                 = bch3121_decode(&tmp, codeword ^ (1 << i) ^ (1 << j));
      syndrome_table[syndrome] = j << 7 | i << 2 | 2;
    }
  }
}